{
    "collab_server" : "",
    "contents" : "library(picante)\nlibrary(ggplot2)\nlibrary(reshape2)\nlibrary(parallel)\n#source(\"https://bioconductor.org/biocLite.R\")\n#biocLite(\"phyloseq\")\n#library(devtools)\n#install_github(\"Russel88/MicEco\")\n#library(MicEco)  #there is a bug in MicEco, don't use it\nmat2vec<-function(x,triangle=FALSE,data.in=NULL){\n  #to convert a matrix or data.frame to three vectors: value,rname,cname\n  #especially when the matrix or data.frame is symmetric or triangle.\n  rownames(x)->rnam\n  colnames(x)->cnam\n  if(!is.matrix(x)){\n    if(is.data.frame(x)) as.matrix(x)->x\n    else stop(\"Input is not a dataframe or matrix.\")\n  }\n  #to test if it's triangle or sysmetric\n  if(isSymmetric(x)){\n    if(!identical(rnam,cnam)) warning(\"Row names is not equal \n                                      to Col names.\")\n    triangle=TRUE\n    data.in=\"lower\"\n  }\n  if(triangle){\n    if(!identical(rnam,cnam)) warning(\"Row names is not equal \n                                      to Col names.\")\n    if(data.in==\"lower\") x[upper.tri(x,diag=TRUE)]<-NA\n    else if(data.in==\"upper\") x[lower.tri(x,diag=TRUE)]<-NA\n    else stop(\"You said it's a triangle matrix, but where is\n              the data?\")\n  }\n  #to convert\t\n  c(x)->value\n  rep(rnam,time=length(cnam))->rowname\n  c(matrix(rep(cnam,time=length(rnam)),byrow=T,nrow=length(rnam),\n           ncol=length(cnam)))->colname\n  data.frame(value,rowname,colname)->y\n  if(triangle){\n    y[!is.na(y$value),]->y\n    rownames(y)<-1:length(rownames(y))\n  }\n  y\n  }\n\n#NTI\n#abundance=T\nses.mntd(rare,cophenetic(root.phylotre),null.model =\"taxa.labels\",\n         abundance.weighted=TRUE)->NTI.df\nNTI<-data.frame(NTI=-NTI.df$mntd.obs.z,SampaleType=Sample.Type)\nfactor(NTI$SampaleType,levels = c(\"UnburntSoil\",\"BurntSoil\",\"PyOM\"))->NTI$SampaleType\nggplot(data=NTI)+\n  geom_boxplot(aes(y=NTI,x=SampaleType,fill=SampaleType))+\n  scale_fill_manual(values=c(color1,color2,color3))+\n  theme_bw(base_size = 12)+\n  theme(panel.grid = element_blank())\n#abundance=F\n# ses.mntd(rare,cophenetic(root.phylotre),null.model =\"taxa.labels\",abundance.weighted=F)->NTI.df2\n# NTI2<-data.frame(NTI=-NTI.df2$mntd.obs.z,SampaleType=Sample.Type)\n# factor(NTI2$SampaleType,levels = c(\"UnburntSoil\",\"BurntSoil\",\"PyOM\"))->NTI2$SampaleType\n# ggplot(data=NTI2)+\n#   geom_boxplot(aes(y=NTI,x=SampaleType,fill=SampaleType))+\n#   scale_fill_manual(values=c(color1,color2,color3))+\n#   theme_bw(base_size = 12)+\n#   theme(panel.grid = element_blank())\n# #abundance=T, asin-root-transformed\n# rare.t<-asin(sqrt(rare)/rowSums(rare)[1])\n# ses.mntd(rare.t,cophenetic(root.phylotre),null.model =\"taxa.labels\",abundance.weighted=T)->NTI.df3\n# NTI3<-data.frame(NTI=-NTI.df3$mntd.obs.z,SampleType=Sample.Type)\n# factor(NTI3$SampleType,levels = c(\"UnburntSoil\",\"BurntSoil\",\"PyOM\"))->NTI3$SampleType\n# ggplot(data=NTI3)+\n#   geom_boxplot(aes(y=NTI,x=SampleType,fill=SampleType))+\n#   scale_fill_manual(values=c(color1,color2,color3))+\n#   theme_bw(base_size = 12)+\n#   theme(panel.grid = element_blank())\n# dput(NTI3,\"D:\\\\World Forest Data\\\\Fuyang\\\\data\\\\1Description\\\\alphaNTI.d\")\n\n#not betaNTI, really. Exactly, NRI\n# betaNTI.df<-ses.mpd(rare,cophenetic(root.phylotre),\n#                     null.model =\"taxa.labels\",abundance.weighted=TRUE)\n# betaNTI<- -betaNTI.df$mpd.obs.z\n\n#betaNTI\ndrop.tip(root.phylotre,root.phylotre$tip.label[!(root.phylotre$tip.label %in% colnames(rare))])->root.phylotre.d\ncophenetic(root.phylotre.d)->root.phylotre.d.dist\nses.beta.mntd(rare,root.phylotre.d.dist,abundance.weighted = T)->betaNTI\n# comdistnt(rare,root.phylotre.d.dist,abundance.weighted = T)->obs\n# #not run\n# cl <- makeCluster(detectCores()-2)  \n# clusterEvalQ(cl,library(picante))\n# clusterExport(cl,c(\"root.phylotre.d.dist\",\"rare\"))\n# parSapply(cl, 1:100, function(i,...) { rare->temp; \n#   #  sample(colnames(rare.t))->colnames(temp);  #wrong, because I need to calculate pair-wisely, I should permute them individually.\n#   t(apply(temp,MARGIN=1,sample))->temp\n#   colnames(rare)->colnames(temp)\n#   comdistnt(temp,root.phylotre.d.dist,abundance.weighted = T) } )->ran\n# stopCluster(cl)\n# apply(X = ran,MARGIN=1,mean)->ran.mean\n# apply(X = ran,MARGIN=1,sd)->ran.sd\n# betaNTI<-obs\n# betaNTI[1:990]<- -(as.numeric(obs)-ran.mean)/ran.sd    #-betaMNTD, i.e. betaNTI\n# as.matrix(betaNTI)->betaNTI\n# diag(betaNTI)<-NA\n# View(betaNTI)\nmedian(abs(betaNTI[isPyOM,isPyOM]),na.rm = T)  #median=7.45\nmedian(abs(betaNTI[isBurnt,isBurnt]),na.rm = T)  #median=10.83\nmedian(abs(betaNTI[isUnburnt,isUnburnt]),na.rm = T)  #median=11.81\nmedian(betaNTI[c(2,4:12),c(2,4:12)],na.rm = T) #remove the two outliers, 12.22\n# rownames(betaNTI.asin.root)<-colnames(betaNTI.asin.root)<-as.character(Sample.Type)\n# betaNTI.asin.root.m<-reshape2::melt(betaNTI.asin.root[c(isUnburnt,isBurnt,isPyOM),\n#                         c(isUnburnt,isBurnt,isPyOM)])\n# dput(betaNTI.asin.root.m,\"D:\\\\World Forest Data\\\\Fuyang\\\\data\\\\1Description\\\\betaNTI.d\")\n# betaNTI.asin.root.m.r<-reshape2::melt(betaNTI.asin.root[c(2,4:12,isBurnt,isPyOM),\n#                                                       c(2,4:12,isBurnt,isPyOM)])\n# betaNTI.asin.root.m.plot<-\n#   betaNTI.asin.root.m[betaNTI.asin.root.m$Var1==betaNTI.asin.root.m$Var2 & !is.na(betaNTI.asin.root.m$value),]\n# betaNTI.asin.root.m.r.plot<-\n#   betaNTI.asin.root.m.r[betaNTI.asin.root.m.r$Var1==betaNTI.asin.root.m.r$Var2 & !is.na(betaNTI.asin.root.m.r$value),]\n# ggplot(data=betaNTI.asin.root.m.plot,aes(x=Var1,y=value))+geom_violin(aes(fill=Var1))+geom_boxplot(width=0.075)\n# ggplot(data=betaNTI.asin.root.m.r.plot,aes(x=Var1,y=value))+geom_violin(aes(fill=Var1))+geom_boxplot(width=0.075)\n# wilcox.test(betaNTI.asin.root.m.plot[betaNTI.asin.root.m.plot$Var1==\"UnburntSoil\",3],\n#             betaNTI.asin.root.m.plot[betaNTI.asin.root.m.plot$Var1==\"BurntSoil\",3])\n# wilcox.test(betaNTI.asin.root.m.r.plot[betaNTI.asin.root.m.r.plot$Var1==\"UnburntSoil\",3],\n#             betaNTI.asin.root.m.r.plot[betaNTI.asin.root.m.r.plot$Var1==\"BurntSoil\",3])\n\nmat2vec(betaNTI[isUnburnt,isUnburnt])->betaNTI.U\nmat2vec(betaNTI[isPyOM,isPyOM])->betaNTI.P\nmat2vec(betaNTI[isBurnt,isBurnt])->betaNTI.B\nmat2vec(betaNTI[isUnburnt,isBurnt])->betaNTI.UB\nmat2vec(betaNTI[isUnburnt,isPyOM])->betaNTI.UP\nmat2vec(betaNTI[isBurnt,isPyOM])->betaNTI.BP\nbetaNTI.U[,2]<-\"U\"; betaNTI.P[,2]<-\"P\"; betaNTI.B[,2]<-\"B\"\nbetaNTI.UB[,2]<-\"UB\"; betaNTI.UP[,2]<-\"UP\"; betaNTI.BP[,2]<-\"BP\"\nrbind(betaNTI.U[,1:2],betaNTI.B[,1:2],betaNTI.P[,1:2],\n      betaNTI.UB[,1:2],betaNTI.UP[,1:2],betaNTI.BP[,1:2])->betaNTI.v\nbetaNTI.v$rowname<-as.factor(betaNTI.v$rowname)\nbetaNTI.v$rowname<-factor(betaNTI.v$rowname,levels=c(\"U\",\"B\",\"P\",\"UB\",\"UP\",\"BP\"))\ndunn.test::dunn.test(betaNTI.v$value,betaNTI.v$rowname,method = \"bonferroni\")\nggplot(data=betaNTI.v, aes(x=rowname,y=value))+\n  #  geom_segment(x=1,y=100,xend=2,yend=100,size=0.5,inherit.aes = F)+geom_segment(x=1,y=150,xend=3,yend=150,size=0.5,inherit.aes = F)+\n#  geom_violin(aes(fill=rowname),linetype=0)+\n  geom_violin(aes(fill=rowname),linetype=0)+geom_boxplot(width=0.2,lwd=0.2,outlier.size = 1.5)+\n  #  geom_blank(aes(y = y_min))+geom_blank(aes(y = y_max))+  #just to set the limits of facet\n  theme_bw(base_size=12)+ guides(fill=FALSE)+\n  theme(panel.grid = element_blank(),\n        axis.title.x=element_blank(),\n        axis.text.x = element_text(color=\"black\"),\n        axis.text.y = element_text(color=\"black\"))+\n  scale_fill_brewer(palette = 6,type = \"qual\")+ylab(expression(beta*\"NTI\"))+ylim(0,17)\n\n\nggplot(betaNIT.m,aes(Var1,Var2))+ \n  geom_tile(aes(fill=value),color = \"lightgray\")+\n  guides(fill=guide_colorbar(\"betaNTI\"))+\n  scale_fill_gradientn(colors=c(\"seagreen\",\"khaki1\",\"firebrick2\"),guide=\"colorbar\") +\n  theme_minimal(15) + \n  theme(panel.grid = element_blank(),\n        axis.title.x=element_blank(),\n        axis.title.y=element_blank(), \n        axis.text.x = element_text(angle = 270, hjust = 0,vjust=0.3,color=\"black\"),\n        axis.text.y = element_text(color=\"black\")\n  )->heatmap.betaNTI\nheatmap.betaNTI\npheatmap::pheatmap(-betaNTI)\n",
    "created" : 1533108375955.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "9|49|44|2|\n",
    "hash" : "3371903754",
    "id" : "31C2D3E5",
    "lastKnownWriteTime" : 1541905061,
    "last_content_update" : 1541905061432,
    "path" : "D:/World Forest Data/Fuyang/data/1&2 Description and Ordinations combination/NTI&betaNTI.R",
    "project_path" : "NTI&betaNTI.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}